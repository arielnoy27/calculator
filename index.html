<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="manifest" href="manifest.json">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Calculator</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%234285f4' width='100' height='100' rx='20'/><text y='75' font-size='60' fill='white' font-family='Arial' x='50' text-anchor='middle'>ðŸ”¢</text></svg>">
    <style>
        /* CSS Variables for Android Calculator Theme */
        :root {
            --bg-primary: #000000;
            --text-primary: #ffffff;
            --text-formula: #c0c0c0;
            --text-result: #a8a8a8;
            --operator-color: #23c015;
            --btn-number: #171719;
            --btn-operator: #919191;
            --btn-equals: #23c015;
            --btn-special: #2d2d2f;
            --btn-hover: rgba(255, 255, 255, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Roboto', 'Google Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
            touch-action: manipulation;
        }

        .calculator {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 600px;
            margin: 0 auto;
            width: 100%;
        }

        /* Display Area */
        .display {
            background: var(--bg-primary);
            padding: 15px 32px 8px;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: flex-end;
            flex: 0 0 25%;
            min-height: 150px;
            overflow: hidden;
        }

        .display-formula {
            font-size: 26px;
            color: var(--text-formula);
            margin-bottom: 10px;
            min-height: 32px;
            word-wrap: break-word;
            text-align: right;
            width: 100%;
            line-height: 1.2;
            font-weight: 400;
        }

        .display-formula .operator {
            color: var(--operator-color);
            margin: 0 4px;
        }

        .display-result {
            font-size: 44px;
            font-weight: 400;
            color: var(--text-result);
            word-wrap: break-word;
            text-align: right;
            width: 100%;
            line-height: 1.1;
            transition: all 0.3s ease;
        }

        .display-result.final {
            color: var(--operator-color);
            font-size: 56px;
        }

        /* State Indicator */
        .state-indicator {
            font-size: 12px;
            color: var(--operator-color);
            margin-bottom: 8px;
            text-align: right;
            min-height: 16px;
        }

        /* Toolbar Icons */
        .toolbar {
            display: flex;
            justify-content: space-between;
            padding: 10px 32px;
            align-items: center;
        }

        .toolbar-left {
            display: flex;
            gap: 24px;
        }

        .toolbar-icon {
            width: 28px;
            height: 28px;
            opacity: 0.6;
            cursor: pointer;
        }

        .toolbar-icon:active {
            opacity: 1;
        }

        /* Delete Icon - Independent Size Control */
        #deleteIcon {
            width: 28px;
            height: 28px;
            opacity: 0.6;
            cursor: pointer;
            flex-shrink: 0;
        }

        #deleteIcon:active {
            opacity: 1;
        }

        /* Divider line */
        .divider {
            height: 2px;
            background: rgba(255, 255, 255, 0.1);
            margin: 0 32px;
        }

        /* Button Grid */
        .buttons {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(5, 1fr);
            gap: 12px;
            padding: 30px 12px 24px;
            max-height: 65vh;
        }

        /* Button Styles */
        .btn {
            background: var(--btn-number);
            border: none;
            border-radius: 50%;
            color: var(--text-primary);
            font-size: 32px;
            font-weight: 400;
            cursor: pointer;
            transition: background 0.2s;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
            aspect-ratio: 1;
        }

        .btn:active {
            background: var(--btn-hover);
        }

        /* Disabled buttons visual 
        .btn:disabled {
            opacity: 0.35;
            cursor: default;
        }
        */

        /* Ripple Effect */
        .ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: scale(0);
            animation: ripple-animation 0.6s ease-out;
            pointer-events: none;
        }

        @keyframes ripple-animation {
            to {
                transform: scale(3);
                opacity: 0;
            }
        }

        /* Button Type Styles */
        .btn-operator {
            background: var(--btn-operator);
            color: #000000;
            font-size: 36px;
            font-weight: 400;
        }

        .btn-special {
            background: var(--btn-special);
            color: var(--text-primary);
            font-size: 28px;
            font-weight: 400;
        }

        .btn-equals {
            background: var(--btn-equals);
            color: var(--text-primary);
            font-size: 40px;
            font-weight: 500;
        }

        .btn-clear {
            color: var(--text-primary);
            font-size: 32px;
            font-weight: 400;
        }

        /* Responsive adjustments */
        @media (max-width: 400px) {
            .display-formula {
                font-size: 24px;
            }
            
            .display-result {
                font-size: 40px;
            }

            .display-result.final {
                font-size: 52px;
            }
            
            .btn {
                font-size: 28px;
            }
            
            .btn-operator {
                font-size: 32px;
            }
        }

        @media (min-height: 800px) {
            .display {
                flex: 0 0 28%;
            }
        }
    </style>
</head>
<body>
    <div class="calculator">
        <!-- Display Area -->
        <div class="display">
            <div class="state-indicator" id="stateIndicator"></div>
            <div class="display-formula" id="formulaDisplay"></div>
            <div class="display-result" id="resultDisplay"></div>
        </div>

        <!-- Toolbar -->
        <div class="toolbar">
            <div class="toolbar-left">
                <svg class="toolbar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <polyline points="12 6 12 12 16 14"/>
                </svg>
                <svg class="toolbar-icon" viewBox="0 0 24 25" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="9" width="20" height="9" rx="1"/>
                    <line x1="8" y1="9" x2="8" y2="15"/>
                    <line x1="13" y1="9" x2="13" y2="15"/>
                    <line x1="18" y1="9" x2="18" y2="15"/>
                </svg>
                <svg class="toolbar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <rect x="4" y="4" width="17" height="17" rx="2.5"/>        
                    <text x="6" y="12.5" font-size="8" fill="currentColor" stroke-width="0.5">âˆš</text>
                    <text x="13" y="18" font-size="8" fill="currentColor" stroke-width="0.5">Ï€</text>
                </svg>
            </div>
            <svg class="toolbar-icon" viewBox="0 0 24 24" fill="none" stroke="#23c015" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
        </div>

        <!-- Divider -->
        <div class="divider"></div>

        <!-- Button Grid -->
        <div class="buttons">
            <!-- Row 1 -->
            <button class="btn btn-special btn-clear" data-action="clear">C</button>
            <button class="btn btn-special" data-action="enter-forcing-mode" id="forcingBtn">[ ]</button>
            <button class="btn btn-special" data-action="apply-forcing-percent">%</button>
            <button class="btn btn-operator" data-action="operator" data-operator="Ã·">Ã·</button>

            <!-- Row 2 -->
            <button class="btn" data-action="number" data-number="7">7</button>
            <button class="btn" data-action="number" data-number="8">8</button>
            <button class="btn" data-action="number" data-number="9">9</button>
            <button class="btn btn-operator" data-action="operator" data-operator="Ã—">Ã—</button>

            <!-- Row 3 -->
            <button class="btn" data-action="number" data-number="4">4</button>
            <button class="btn" data-action="number" data-number="5">5</button>
            <button class="btn" data-action="number" data-number="6">6</button>
            <button class="btn btn-operator" data-action="operator" data-operator="âˆ’">âˆ’</button>

            <!-- Row 4 -->
            <button class="btn" data-action="number" data-number="1">1</button>
            <button class="btn" data-action="number" data-number="2">2</button>
            <button class="btn" data-action="number" data-number="3">3</button>
            <button class="btn btn-operator" data-action="operator" data-operator="+">+</button>

            <!-- Row 5 -->
            <button class="btn" data-action="toggle-sign">+/âˆ’</button>
            <button class="btn" data-action="number" data-number="0">0</button>
            <button class="btn" data-action="decimal">.</button>
            <button class="btn btn-equals" data-action="equals">=</button>
        </div>
    </div>

    <script>
        // Calculator with Forcing Number State and divide-lock mode
        class AdvancedCalculator {
            constructor() {
                this.formulaDisplay = document.getElementById('formulaDisplay');
                this.resultDisplay = document.getElementById('resultDisplay');
                this.stateIndicator = document.getElementById('stateIndicator');
                
                // State variables
                this.state = 0; // 0 = normal, 1 = forcing number mode
                this.forcing_number = null;

                // Divide lock mode: only % clickable when true
                this.isDivideLockMode = false;
                this.buttons = null; // will be set in initializeEventListeners
                
                // Calculator variables
                this.formula = '';
                this.currentNumber = '';
                this.result = '';
                this.lastOperator = null;
                this.shouldResetOnNextInput = false;
                this.justCalculated = false;
                
                this.initializeEventListeners();
                this.updateStateIndicator();
                this.updateForcingButton();
            }

            // Initialize all button event listeners
            initializeEventListeners() {
                this.buttons = document.querySelectorAll('.btn');

                this.buttons.forEach(button => {
                    button.addEventListener('click', (e) => {
                        this.createRipple(e);
                        this.handleButtonClick(button);
                    });
                });

                // Add delete icon listener - find the X button (green icon)
                const toolbarIcons = document.querySelectorAll('.toolbar-icon');
                const deleteIcon = toolbarIcons[toolbarIcons.length - 1]; // Last icon is the X
                if (deleteIcon) {
                    deleteIcon.addEventListener('click', (e) => {
                        this.handleBackspace();
                    });
                }
            }

            // Enter divide lock mode: only % button enabled
            enterDivideLockMode() {
                this.isDivideLockMode = true;
                this.updateButtonsEnabledState();
            }

            // Exit divide lock mode: all buttons enabled
            exitDivideLockMode() {
                if (!this.isDivideLockMode) return;
                this.isDivideLockMode = false;
                this.updateButtonsEnabledState();
            }

            // Apply enabled/disabled state to all buttons
            updateButtonsEnabledState() {
                if (!this.buttons) return;

                this.buttons.forEach(button => {
                    const action = button.dataset.action;

                    if (this.isDivideLockMode) {
                        const isPercent = action === 'apply-forcing-percent';
                        button.disabled = !isPercent;
                    } else {
                        button.disabled = false;
                    }
                });
            }

            // Create ripple effect
            createRipple(e) {
                const button = e.currentTarget;
                const ripple = document.createElement('span');
                const rect = button.getBoundingClientRect();
                const size = Math.max(rect.width, rect.height);
                const x = e.clientX - rect.left - size / 2;
                const y = e.clientY - rect.top - size / 2;

                ripple.style.width = ripple.style.height = size + 'px';
                ripple.style.left = x + 'px';
                ripple.style.top = y + 'px';
                ripple.classList.add('ripple');

                button.appendChild(ripple);
                setTimeout(() => ripple.remove(), 600);
            }

            // Handle button clicks
            handleButtonClick(button) {
                const action = button.dataset.action;

                switch (action) {
                    case 'number':
                        this.inputNumber(button.dataset.number);
                        break;
                    case 'decimal':
                        this.inputDecimal();
                        break;
                    case 'operator':
                        this.inputOperator(button.dataset.operator);
                        break;
                    case 'equals':
                        this.calculate();
                        break;
                    case 'clear':
                        this.clear();
                        break;
                    case 'toggle-sign':
                        this.toggleSign();
                        break;
                    case 'enter-forcing-mode':
                        this.enterForcingMode();
                        break;
                    case 'apply-forcing-percent':
                        this.applyForcingPercent();
                        break;
                }
            }

            // Enter forcing number mode
            enterForcingMode() {
                if (this.state === 0) {
                    this.state = 1;
                    this.currentNumber = '';
                    this.formula = '';
                    this.resultDisplay.textContent = '';
                    this.formulaDisplay.textContent = 'Enter forcing number';
                    this.updateStateIndicator();
                }
            }

            // Apply forcing percent logic
            applyForcingPercent() {
                // Whenever % is pressed, exit divide-lock mode if active
                if (this.isDivideLockMode) {
                    this.exitDivideLockMode();
                }

                if (this.state === 0 && this.forcing_number !== null && this.currentNumber !== '' && this.formula !== '') {
                    // Find the last operator position in formula
                    const lastOperatorIndex = this.findLastOperatorIndex(this.formula);
                    
                    if (lastOperatorIndex !== -1) {
                        // Get everything BEFORE the last operator
                        const expressionBeforeLast = this.formula.substring(0, lastOperatorIndex);
                        const lastOperator = this.formula[lastOperatorIndex];
                        
                        try {
                            // Evaluate: (1+2+3+4) from expressionBeforeLast
                            const resultBeforeLast = this.evaluateExpression(expressionBeforeLast);
                            
                            // Apply the formula: new_last_number = resultBeforeLast - forcing_number
                            const newLastNumber = resultBeforeLast - this.forcing_number;
                            
                            // Update formula with the last operator (to be ready for next input)
                            this.formula = expressionBeforeLast + lastOperator;
                            // Replace current number with the calculated result
                            this.currentNumber = String(newLastNumber);
                            
                            this.updateFormula();
                            this.calculatePreview();
                        } catch (e) {
                            console.log('Error applying forcing percent');
                        }
                    }
                }
            }

            // Find last operator position
            findLastOperatorIndex(expr) {
                for (let i = expr.length - 1; i >= 0; i--) {
                    if (['Ã·', 'Ã—', 'âˆ’', '+'].includes(expr[i])) {
                        return i;
                    }
                }
                return -1;
            }

            // Input number
            inputNumber(num) {
                if (this.state === 1) {
                    // Forcing number mode
                    this.currentNumber += num;
                    this.resultDisplay.textContent = this.currentNumber;
                    this.updateForcingButton();
                } else {
                    // Normal mode
                    if (this.shouldResetOnNextInput) {
                        this.formula = '';
                        this.currentNumber = '';
                        this.shouldResetOnNextInput = false;
                        this.resultDisplay.classList.remove('final');
                    }

                    this.currentNumber += num;
                    this.updateFormula();
                    this.calculatePreview();
                }
            }

            // Input decimal
            inputDecimal() {
                if (this.state === 1) {
                    if (!this.currentNumber.includes('.')) {
                        this.currentNumber += this.currentNumber === '' ? '0.' : '.';
                        this.resultDisplay.textContent = this.currentNumber;
                    }
                } else {
                    if (this.shouldResetOnNextInput) {
                        this.formula = '';
                        this.currentNumber = '0';
                        this.shouldResetOnNextInput = false;
                        this.resultDisplay.classList.remove('final');
                    }

                    if (!this.currentNumber.includes('.')) {
                        this.currentNumber += this.currentNumber === '' ? '0.' : '.';
                        this.updateFormula();
                    }
                }
            }

            // Input operator
            inputOperator(operator) {
                if (this.state === 1) return; // Ignore in forcing mode

                // Special behavior for divide:
                // when Ã· is pressed, do not modify the formula, just lock the buttons
                if (operator === 'Ã·') {
                    this.enterDivideLockMode();
                    return;
                }

                if (this.shouldResetOnNextInput) {
                    this.formula = this.result;
                    this.currentNumber = '';
                    this.shouldResetOnNextInput = false;
                    this.resultDisplay.classList.remove('final');
                }

                if (this.currentNumber !== '') {
                    this.formula += this.currentNumber;
                    this.currentNumber = '';
                }

                if (this.formula.length > 0 && this.isOperator(this.formula[this.formula.length - 1])) {
                    this.formula = this.formula.slice(0, -1);
                }

                this.formula += operator;
                this.lastOperator = operator;
                this.updateFormula();
                this.calculatePreview();
            }

            // Check if operator
            isOperator(char) {
                return ['Ã·', 'Ã—', 'âˆ’', '+'].includes(char);
            }

            // Calculate preview
            calculatePreview() {
                try {
                    let expression = this.formula + this.currentNumber;
                    if (expression === '' || this.isOperator(expression[expression.length - 1])) {
                        this.resultDisplay.textContent = '';
                        return;
                    }

                    const result = this.evaluateExpression(expression);
                    this.resultDisplay.textContent = this.formatNumber(result);
                    this.resultDisplay.classList.remove('final');
                } catch (e) {
                    this.resultDisplay.textContent = '';
                }
            }

            // Calculate final result
            calculate() {
                if (this.state === 1) {
                    // Save forcing number and return to normal mode
                    if (this.currentNumber !== '') {
                        this.forcing_number = parseFloat(this.currentNumber);
                        this.state = 0;
                        this.currentNumber = '';
                        this.formula = '';
                        this.resultDisplay.textContent = '';
                        this.formulaDisplay.textContent = '';
                        this.updateStateIndicator();
                        this.updateForcingButton();
                    }
                } else {
                    // Normal calculation
                    try {
                        let expression = this.formula + this.currentNumber;
                        if (expression === '') return;

                        const result = this.evaluateExpression(expression);
                        this.result = String(result);
                        
                        this.formulaDisplay.textContent = '';
                        this.resultDisplay.textContent = this.formatNumber(result);
                        this.resultDisplay.classList.add('final');
                        
                        this.shouldResetOnNextInput = true;
                        this.currentNumber = '';
                    } catch (e) {
                        this.resultDisplay.textContent = 'Error';
                    }
                }
            }

            // Evaluate expression
            evaluateExpression(expr) {
                expr = expr.replace(/Ã·/g, '/').replace(/Ã—/g, '*').replace(/âˆ’/g, '-');
                const tokens = this.tokenize(expr);
                return this.parseExpression(tokens);
            }

            // Tokenize
            tokenize(expr) {
                const tokens = [];
                let currentNumber = '';

                for (let i = 0; i < expr.length; i++) {
                    const char = expr[i];
                    if (char >= '0' && char <= '9' || char === '.') {
                        currentNumber += char;
                    } else if (['+', '-', '*', '/'].includes(char)) {
                        if (currentNumber) {
                            tokens.push(parseFloat(currentNumber));
                            currentNumber = '';
                        }
                        tokens.push(char);
                    }
                }

                if (currentNumber) {
                    tokens.push(parseFloat(currentNumber));
                }

                return tokens;
            }

            // Parse expression
            parseExpression(tokens) {
                for (let i = 1; i < tokens.length - 1; i += 2) {
                    if (tokens[i] === '*' || tokens[i] === '/') {
                        const result = tokens[i] === '*' 
                            ? tokens[i - 1] * tokens[i + 1]
                            : tokens[i - 1] / tokens[i + 1];
                        tokens.splice(i - 1, 3, result);
                        i -= 2;
                    }
                }

                let result = tokens[0];
                for (let i = 1; i < tokens.length; i += 2) {
                    const operator = tokens[i];
                    const nextNum = tokens[i + 1];
                    if (operator === '+') {
                        result += nextNum;
                    } else if (operator === '-') {
                        result -= nextNum;
                    }
                }

                return result;
            }

            // Format number
            formatNumber(num) {
                if (!isFinite(num)) return 'Error';
                const rounded = Math.round(num * 100000000) / 100000000;
                return rounded.toString();
            }

            // Update formula display
            updateFormula() {
                let displayText = this.formula + this.currentNumber;
                displayText = displayText.replace(/([Ã·Ã—âˆ’+])/g, '<span class="operator">$1</span>');
                this.formulaDisplay.innerHTML = displayText;
            }

            // Clear
            clear() {
                if (this.state === 1) {
                    this.state = 0;
                    this.currentNumber = '';
                    this.resultDisplay.textContent = '';
                    this.formulaDisplay.textContent = '';
                    this.updateStateIndicator();
                    this.updateForcingButton();
                } else {
                    // Reset forcing number when pressing C in normal mode
                    this.forcing_number = null;
                    this.formula = '';
                    this.currentNumber = '';
                    this.result = '';
                    this.shouldResetOnNextInput = false;
                    this.formulaDisplay.textContent = '';
                    this.resultDisplay.textContent = '';
                    this.resultDisplay.classList.remove('final');
                    this.updateForcingButton();
                }
            }

            // Toggle sign
            toggleSign() {
                // You can implement this if you want.
                // Left empty here like in your original code.
            }

            // Handle backspace
            handleBackspace() {
                if (this.state === 1) {
                    // In forcing number mode, delete from current number
                    if (this.currentNumber !== '') {
                        this.currentNumber = this.currentNumber.slice(0, -1);
                        this.resultDisplay.textContent = this.currentNumber;
                    }
                } else {
                    // In normal mode, delete from current number or formula
                    if (this.currentNumber !== '') {
                        this.currentNumber = this.currentNumber.slice(0, -1);
                    } else if (this.formula !== '') {
                        this.formula = this.formula.slice(0, -1);
                    }
                    
                    this.updateFormula();
                    this.calculatePreview();
                }
            }

            // Update state indicator
            updateStateIndicator() {
                // State indicator is hidden. Forcing button reflects the state.
            }

            // Update forcing button display
            updateForcingButton() {
                const forcingBtn = document.getElementById('forcingBtn');
                if (this.forcing_number !== null) {
                    forcingBtn.textContent = '( )';
                    forcingBtn.style.color = 'var(--text-primary)';
                } else {
                    forcingBtn.textContent = '[ ]';
                    forcingBtn.style.color = 'var(--text-primary)';
                }
            }
        }

        // Initialize
        const calculator = new AdvancedCalculator();
    </script>
</body>
</html>
